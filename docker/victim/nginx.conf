# ============================================================================
# nginx.conf — Cấu hình Nginx cho victim-server
# ============================================================================
# Cấu hình tối giản: phục vụ web tĩnh trên port 80.
# Bật access log format chuẩn (combined) để defender.py có thể parse.
# ============================================================================

# Chạy Nginx dưới dạng daemon (nền) — entrypoint sẽ quản lý
daemon on;

# Worker processes: 1 là đủ cho demo
worker_processes 1;

# File lưu PID (cần cho lệnh nginx -s stop)
pid /run/nginx.pid;

events {
    # Số kết nối đồng thời tối đa mỗi worker
    worker_connections 1024;
}

http {
    # ======================== LOG FORMAT ========================
    # Dùng combined format (chuẩn) — đây là format mà detector.py parse
    # Format: IP - - [datetime] "METHOD PATH PROTOCOL" STATUS SIZE "REFERER" "USER-AGENT"
    log_format combined_custom '$remote_addr - $remote_user [$time_local] '
                               '"$request" $status $body_bytes_sent '
                               '"$http_referer" "$http_user_agent"';

    # Access log: ghi TẤT CẢ request vào file này
    access_log /var/log/nginx/access.log combined_custom;

    # Error log
    error_log /var/log/nginx/error.log warn;

    # ======================== MIME TYPES ========================
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # ======================== PERFORMANCE =======================
    sendfile on;
    keepalive_timeout 65;

    # ======================== SERVER BLOCK ======================
    server {
        # Lắng nghe trên port 80 (HTTP)
        listen 80 default_server;
        server_name _;

        # Document root: thư mục chứa file HTML
        root /var/www/html;
        index index.html;

        # Xử lý tất cả request — trả về file hoặc 404
        # Quan trọng: KHÔNG chặn request xấu ở đây
        # để defender.py có cơ hội phát hiện và ghi log
        location / {
            try_files $uri $uri/ =404;
        }
    }
}
